{% extends "layout.html" %}
{% block content %}
<h2 class="fw-bold mb-4 text-center">Modo Carrera</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="row">
  <!-- AÑADIR JUGADOR -->
  <div class="col-md-12 mb-4">
    <div class="card bg-secondary p-3">
      <h5>Añadir Jugador</h5>
      <form method="POST" action="/add_player" class="row g-2">
        <div class="col-md-2">
          <select name="position" class="form-select" required>
            <option value="">Posición</option>
            {% for pos in POSITIONS %}<option value="{{ pos }}">{{ pos }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-3"><input name="name" class="form-control" placeholder="Nombre" required></div>
        <div class="col-md-1"><input name="age" type="number" class="form-control" placeholder="Edad" required></div>
        <div class="col-md-2"><input name="nationality" class="form-control" placeholder="Nacionalidad" required></div>
        <div class="col-md-1"><input name="grl" type="number" min="1" max="99" class="form-control" placeholder="GRL" required></div>
        <div class="col-md-1"><input name="market_value" type="number" step="1" class="form-control" placeholder="Valor (€)" required></div>
        <div class="col-md-1"><input name="salary" type="number" step="1" class="form-control" placeholder="Sueldo (€)" required></div>
        <div class="col-md-12 mt-2 text-end"><button class="btn btn-primary">Añadir jugador</button></div>
      </form>
    </div>
  </div>

  <!-- INFORMACIÓN DE PARTIDOS -->
  <div class="col-md-12 mb-4">
    <div class="card bg-secondary p-3">
      <h5>Información de partidos (por temporada)</h5>
      <form method="POST" action="/create_season" class="row g-2 mb-2">
        <div class="col-md-4"><input name="season_name" class="form-control" placeholder="Nombre temporada (ej. 2025/26)"></div>
        <div class="col-md-2"><button class="btn btn-outline-light">Crear temporada</button></div>
      </form>

      <form method="POST" action="/add_match_info" class="row g-2">
        <div class="col-md-3">
          <select name="season_id" class="form-select" required>
            <option value="">Selecciona temporada</option>
            {% for s in seasons %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <select name="player_id" class="form-select" required>
            <option value="">Selecciona jugador</option>
            {% for p in players %}<option value="{{ p.id }}">{{ p.name }} ({{ p.position }})</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2"><input name="matches" type="number" class="form-control" placeholder="Partidos"></div>
        <div class="col-md-2"><input name="goals" type="number" class="form-control" placeholder="Goles"></div>
        <div class="col-md-2"><input name="assists" type="number" class="form-control" placeholder="Asistencias"></div>
        <div class="col-md-12 mt-2 text-end"><button class="btn btn-primary">Añadir datos temporada</button></div>
      </form>
    </div>
  </div>

  <!-- FINANZAS & TABLA -->
  <div class="col-md-12">
    <div class="card bg-secondary p-3 mb-3">
      <h5>Finanzas (editable)</h5>
      <p class="text-muted">Edita valor de mercado y sueldo por jugador (valores en €):</p>
      <div class="table-responsive">
      <table class="table table-dark table-striped align-middle">
        <thead><tr>
          <th>Pos</th><th>Nombre</th><th>Edad</th><th>Nacionalidad</th><th>GRL</th><th>Partidos</th><th>Goles</th><th>Asist</th><th>Valor</th><th>Sueldo</th><th>Acciones</th>
        </tr></thead>
        <tbody>
          {% for p in players %}
          <tr>
            <td>{{ p.position }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.age }}</td>
            <td>{{ p.nationality }}</td>
            <td><span class="badge {{ grl_class(p.grl) }}">{{ p.grl }}</span></td>
            <td>{{ aggregates[p.id].matches_sum }}</td>
            <td>{{ aggregates[p.id].goals_sum }}</td>
            <td>{{ aggregates[p.id].assists_sum }}</td>
            <td>{{ p.market_value | currency }}</td>
            <td>{{ p.salary | currency }}</td>
            <td>
              <form action="/delete_player/{{ p.id }}" method="post" style="display:inline-block">
                <button class="btn btn-sm btn-danger" type="submit">Eliminar</button>
              </form>

              <!-- editar finanzas (modal simple con formulario post a /edit_finance) -->
              <form action="/edit_finance/{{ p.id }}" method="post" style="display:inline-block" class="ms-1">
                <input name="market_value" value="{{ p.market_value }}" type="hidden">
                <input name="salary" value="{{ p.salary }}" type="hidden">
                <button class="btn btn-sm btn-outline-light" type="button" onclick="openFinanceEditor({{p.id}}, '{{p.name}}', '{{p.market_value}}', '{{p.salary}}')">Editar</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </div>
    <p class="text-muted">* La tabla global suma los datos de todas las temporadas.</p>
  </div>
</div>

<!-- Modal simple (bootstrap) -->
<div class="modal fade" id="financeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="financeForm" method="post">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title">Editar finanzas</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2"><label class="form-label">Jugador</label><input id="fm_name" class="form-control" readonly></div>
          <div class="mb-2"><label class="form-label">Valor (€)</label><input id="fm_value" name="market_value" class="form-control" required></div>
          <div class="mb-2"><label class="form-label">Sueldo (€)</label><input id="fm_salary" name="salary" class="form-control" required></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
function openFinanceEditor(id, name, mv, sal){
  const form = document.getElementById('financeForm');
  form.action = '/edit_finance/' + id;
  document.getElementById('fm_name').value = name;
  document.getElementById('fm_value').value = mv;
  document.getElementById('fm_salary').value = sal;
  var modal = new bootstrap.Modal(document.getElementById('financeModal'));
  modal.show();
}
</script>

{% endblock %}
